---

- block:
    - name: Enable Apache 2 modules
      apache2_module: >
        name={{ item }} state=present
      with_items:
        - ssl
        - rewrite

    - name: Configure Apache 2 options
      lineinfile: >
        dest=/etc/apache2/apache2.conf regexp=^HostnameLookups line='HostnameLookups On'

    - name: Configure ownCloud
      template: >
        src=config.php.j2 dest=/var/www/owncloud/config/config.php backup=yes owner=www-data group=www-data mode=640

    - name: Remove ownCloud default site
      file: >
        name=/etc/apache2/{{ item }}.conf state=absent
      notify: reload apache2
      with_items:
        - conf-available/owncloud
        - conf-enabled/owncloud
        - sites-available/000-default
        - sites-enabled/000-default

    - name: Configure ownCloud site
      template: >
        src=owncloud.conf.j2 dest=/etc/apache2/sites-available/owncloud.conf owner=root group=root mode=644
      notify: reload apache2

    - name: Enable ownCloud site
      file: >
        src=/etc/apache2/sites-available/owncloud.conf dest=/etc/apache2/sites-enabled/owncloud.conf state=link
      notify: reload apache2
  become: yes
