---

- block:
    - name: Configure Nginx
      template: >
        src=nginx.conf.j2 dest=/etc/nginx/nginx.conf mode=644
      notify: '{{ nginx_daemon_mode }} reload nginx'

    - name: Create Nginx directories
      file: >
        name={{ item }} mode=755 state=directory
      with_items:
        - /etc/nginx/sites-enabled/
        - /var/lib/nginx/

    - name: Remove default site
      file: >
        path=/etc/nginx/sites-enabled/default state=absent
      notify: '{{ nginx_daemon_mode }} reload nginx'

    - block:
        - name: Configure Nginx service
          template: >
            src=supervisor.conf.j2 dest=/etc/supervisor/conf.d/nginx.conf mode=644
          notify: '{{ nginx_daemon_mode }} restart nginx'

        - name: Install Nginx service
          supervisorctl: >
            name=nginx state=present
      when: "nginx_daemon_mode == 'supervisor'"

    - name: Configure Nginx service
      template: >
        src=init.d.j2 dest=/etc/init.d/nginx mode=755
      notify: '{{ nginx_daemon_mode }} restart nginx'
      when: "nginx_daemon_mode == 'systemv'"
  become: yes
