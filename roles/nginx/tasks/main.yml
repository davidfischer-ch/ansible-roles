# Install and configure Nginx, daemonize with Supervisor, enable our Site
# https://blog.engineyard.com/2011/useful-rewrites-for-nginx
---

- block:
    - debug: >
        var=nginx_daemon_mode

    - assert:
        that: "nginx_daemon_mode in ['supervisor', 'systemv']"
  tags: always
  when: nginx_has_run is undefined

- include: 1-daemon.yml
  tags: config
  when: nginx_has_run is undefined

- include: 2-pagespeed.yml
  tags: packages
  when: nginx_has_run is undefined and nginx_pagespeed_enabled|bool

- include: 3-packages.yml
  tags: packages
  when: nginx_has_run is undefined

- include: 4-config.yml
  tags: config
  when: nginx_has_run is undefined

- include: 5-services.yml
  tags: services
  when: nginx_has_run is undefined

- include: 6-update.yml
  tags: update
  when: nginx_has_run is undefined

- include: 7-sites.yml
  tags: config

- set_fact: nginx_has_run=yes
