---

# https://github.com/nginx/nginx.git

- name: Create Nginx source directories
  file: >
    name={{ item }} owner={{ user }} group={{ group }} mode=755 recurse=no state=directory
  become: yes
  with_items:
    - "{{ tools_src_directory }}/nginx"
    - "{{ tools_src_directory }}/nginx-upload-module"
    - "{{ tools_src_directory }}/nginx-upload-progress-module"
    - "{{ tools_src_directory }}/nginx-zip-module"
    - "{{ tools_src_directory }}"

- name: Clone Nginx source code
  git: >
    repo=https://github.com/nginx/nginx.git
    dest={{ tools_src_directory }}/nginx
    force=yes
    version={{ nginx_version }}
  notify: restart nginx

- name: Clone Upload module source code
  git: >
    repo=https://github.com/vkholodkov/nginx-upload-module.git
    dest={{ tools_src_directory }}/nginx-upload-module
    force=yes
    version={{ nginx_upload_module_version }}
  notify: restart nginx

- name: Clone Upload Progress module source code
  git: >
    repo=https://github.com/masterzen/nginx-upload-progress-module.git
    dest={{ tools_src_directory }}/nginx-upload-progress-module
    force=yes
    version={{ nginx_upload_progress_module_version }}
  notify: restart nginx

- name: Clone Zip module source code
  git: >
    repo=https://github.com/evanmiller/mod_zip.git
    dest={{ tools_src_directory }}/nginx-zip-module
    force=yes
    version={{ nginx_zip_module_version }}
  notify: restart nginx

- name: Configure Nginx build process
  command: >
    ./auto/configure
      --prefix=/usr/share/nginx
      --conf-path=/etc/nginx/nginx.conf
      --http-log-path=/var/log/nginx/access.log
      --error-log-path=/var/log/nginx/error.log
      --lock-path=/var/lock/nginx.lock
      --pid-path=/run/nginx.pid
      --http-client-body-temp-path=/var/lib/nginx/body
      --http-fastcgi-temp-path=/var/lib/nginx/fastcgi
      --http-proxy-temp-path=/var/lib/nginx/proxy
      --http-scgi-temp-path=/var/lib/nginx/scgi
      --http-uwsgi-temp-path=/var/lib/nginx/uwsgi
      --with-pcre-jit
      --with-ipv6
      --with-http_ssl_module
      --with-http_stub_status_module
      --with-http_realip_module
      --with-http_addition_module
      --with-http_dav_module
      --with-http_geoip_module
      --with-http_gzip_static_module
      --with-http_image_filter_module
      --with-http_spdy_module
      --with-http_sub_module
      --with-http_xslt_module
      --with-http_auth_request_module
      --add-module={{ tools_src_directory }}/nginx-upload-module
      --add-module={{ tools_src_directory }}/nginx-upload-progress-module
      --add-module={{ tools_src_directory }}/nginx-zip-module
      {{ nginx_pagespeed_configure }}
  args:
    chdir: "{{ tools_src_directory }}/nginx"

- name: Build Nginx from source
  command: >
    make -j{{ ansible_processor_cores }}
  args:
    chdir: "{{ tools_src_directory }}/nginx"

- name: Install Nginx from source
  command: >
    make install
  args:
    chdir: "{{ tools_src_directory }}/nginx"
  become: yes
