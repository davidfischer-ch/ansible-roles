---

- block:
    - name: Setup the Nginx sites
      template: >
        src={{ item.value.config_file }} dest=/etc/nginx/sites-enabled/{{ item.value.name }}.conf mode=644
      notify: '{{ nginx_daemon_mode }} reload nginx'
      with_dict: '{{ nginx_sites }}'

    - name: Create the Nginx sites logs directory
      file: >
        name=/var/log/nginx/{{ item.value.name }} owner={{ nginx_daemon_user }} group={{ nginx_daemon_group }} mode=755
        recurse=yes state=directory
      with_dict: '{{ nginx_sites }}'

    - name: Check Nginx config
      command: >
        {{ nginx_daemon_path }} -t
  become: yes
