---

- block:
    - name: Configure Nginx
      template: >
        src={{ nginx_config_file }} dest=/etc/nginx/nginx.conf mode=644
      notify: '{{ nginx_daemon_mode }} reload nginx'

    - name: Create Nginx directories
      file: >
        name={{ item.name }} owner={{ item.owner|default(omit) }} group={{ item.group|default(omit) }} mode=755
        state=directory
      with_items:
        - { name: '/etc/nginx/sites-enabled/' }
        - { name: '/var/lib/nginx/' }
        - { name: '/var/log/nginx/', owner: '{{ nginx_daemon_user }}', group: '{{ nginx_daemon_group }}' }

    - name: Remove default site
      file: >
        path=/etc/nginx/sites-enabled/default state=absent
      notify: '{{ nginx_daemon_mode }} reload nginx'

    - block:
        - name: Configure Nginx service
          template: >
            src=supervisor.conf.j2 dest=/etc/supervisor/conf.d/nginx.conf mode=644
          notify: '{{ nginx_daemon_mode }} restart nginx'

        - name: Install Nginx service
          supervisorctl: >
            name=nginx state=present
      when: "nginx_daemon_mode == 'supervisor'"

    - name: Configure Nginx service
      template: >
        src=init.d.j2 dest=/etc/init.d/nginx mode=755
      notify: '{{ nginx_daemon_mode }} restart nginx'
      when: "nginx_daemon_mode == 'systemv'"
  become: yes
