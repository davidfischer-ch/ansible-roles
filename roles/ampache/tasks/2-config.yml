---

- block:
    - name: Create Ampache directories
      file: >
        name={{ item }} owner=www-data group=www-data mode=755 recurse=no state=directory
      when: item|length > 0
      with_items:
        - '{{ ampache_log_directory }}'
        - '{{ ampache_metadata_directory }}'
        - '{{ ampache_tmp_directory }}'

    - name: Enable Apache 2 modules
      apache2_module: >
        name={{ item }} state=present
      with_items:
        - ssl
        - rewrite

    - name: Configure Ampache
      template: >
        src={{ item.name }}.j2 dest=/usr/share/ampache/www2/{{ item.path }} owner=root group=root mode=644
      notify: reload apache2
      with_items:
        - { name: 'ampache.cfg.php', path: 'config/ampache.cfg.php' }
        - { name: 'rest-htaccess',   path: 'rest/.htaccess' }

    - name: Remove Ampache default site
      file: >
        name=/etc/apache2/{{ item }}.conf state=absent
      notify: reload apache2
      with_items:
        - conf-available/ampache
        - conf-enabled/ampache
        - sites-available/000-default
        - sites-enabled/000-default

    - name: Configure Ampache site
      template: >
        src=ampache.conf.j2 dest=/etc/apache2/sites-available/ampache.conf owner=root group=root mode=644
      notify: reload apache2

    - name: Enable Ampache site
      file: >
        src=/etc/apache2/sites-available/ampache.conf dest=/etc/apache2/sites-enabled/ampache.conf state=link
      notify: reload apache2
  become: yes
