---

- name: Install Ampache packages
  apt: >
    name=ampache state=latest
  become: yes

- name: Create Ampache source directories
  file: >
    name={{ item }} owner={{ user }} group={{ group }} mode=755 recurse=no state=directory
  become: yes
  with_items:
    - '{{ tools_src_directory }}/ampache'
    - '{{ tools_src_directory }}'

- block:
    - name: Clone Ampache source code
      git: >
        repo=https://github.com/ampache/ampache.git
        dest={{ tools_src_directory }}/ampache
        force=yes
        version={{ ampache_version }}

    - name: Install Ampache from source
      command: >
        rsync -ah -lH --delete {{ tools_src_directory }}/ampache/ /usr/share/ampache/www2/ --exclude=.git
        --exclude=lib/components --exclude=lib/vendor --exclude=config/ampache.cfg.php --exclude=rest/.htaccess
      changed_when: ampache_install_result.stdout|length > 1
      register: ampache_install_result

    - name: Install Ampache dependencies
      command: >
        composer install --prefer-source --no-interaction
      args:
        chdir: '{{ ampache_web_directory }}'
      changed_when: "'Nothing to install or update' not in ampache_install_result.stderr"
      register: ampache_install_result
  become: yes
