# Configure password-less ssh for automating next steps
---

- block:
    - name: Create system user
      user: >
        name={{ user }} shell=/bin/bash state=present
      become: yes

    - name: Add user to password-less sudoers
      template: >
        src=sudoers-user.j2 dest=/etc/sudoers.d/{{ user }}-sudoer
        owner=root group=root mode=440 validate='visudo -cf %s'
      become: yes
      when: "user != 'root'"

    - name: Enable password-less ssh
      authorized_key: >
        user={{ user }} key="{{ lookup('file', item) }}"
      with_items: '{{ ssh_authorized_keys }}'
  tags: [bootstrap, config]
  when: bootstrap_enabled|bool
