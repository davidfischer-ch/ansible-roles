---

- block:
    - name: Install extra PPA repositories
      apt_repository: >
        repo={{ item }} state=present
      register: extra_ppa_result
      with_items: '{{ extra_ppa_repos }}'

    - name: Fix any previously running Debian packages upgrade
      command: >
        dpkg --configure -a
      changed_when: upgrade_fix_result.stdout|length > 0
      register: upgrade_fix_result
      when: upgrade_packages|bool

    - name: Upgrade the Debian packages
      apt: >
        upgrade=full update_cache=yes cache_valid_time={{ upgrade_packages_cache_valid_time }}
      async: '{{ upgrade_packages_async }}'
      poll: '{{ upgrade_packages_poll }}'
      when: upgrade_packages|bool

    - name: Cleanup the Debian packages
      shell: >
        apt-get -y autoremove && apt-get -y autoclean
      changed_when: upgrade_cleanup_result.stdout_lines|length > 7
      register: upgrade_cleanup_result
      when: upgrade_packages|bool

    - name: Install extra Debian packages
      apt: >
        name={{ item }} state=latest
      with_items: '{{ extra_packages }}'

    - name: Set swappiness
      sysctl: >
        name=vm.swappiness value={{ vm_swappiness|int }} sysctl_set=yes state=present
  become: yes
