---

- name: Install GitHub python packages
  local_action: >
    pip name={{ item }} executable=pip2 state=present
  become: yes
  tags: [github, packages]
  with_items: '{{ github_python_packages }}'

- block:
    - name: Lookup GitHub IP addresses if necessary
      set_fact:
        github_ips: "{{ github_ips|default(lookup('dig', 'github.com').split(',')) }}"

    - name: Add GitHub public key to known_hosts file
      lineinfile: >
        path={{ ansible_user_dir }}/.ssh/known_hosts regexp=^github.com create=yes state=present
        line='github.com,{{ github_ips|sort|join(',') }} ssh-rsa {{ github_rsa }}'

    - name: Add GitHub IP addresses to hosts file
      lineinfile: >
        path=/etc/hosts regexp=' github.com$' line='{{ github_ips|sort|first }} github.com' create=yes state=present
      become: yes
  tags: [github, config]
