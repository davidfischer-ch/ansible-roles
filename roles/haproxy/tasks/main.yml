# Install and configure HAProxy
# http://www.networkinghowtos.com/howto/compile-haproxy-from-source-on-ubuntu/
# http://louwrentius.com/how-to-compile-haproxy-from-source-and-setup-a-basic-configuration.html
---

- block:
    - name: Create HAProxy source directories
      file: >
        name={{ tools_src_directory }} owner={{ user }} group={{ group }} mode=755 recurse=no state=directory
      become: yes

    - name: Clone HAProxy source code
      git: >
        repo=https://github.com/haproxy/haproxy.git
        dest={{ tools_src_directory }}/haproxy
        force=yes
        version={{ haproxy_version }}

    - name: Build HAProxy from source
      command: >
        make -j{{ ansible_processor_cores }} TARGET={{ haproxy_build_target }} {{ haproxy_build_flags }}
      args:
        chdir: '{{ tools_src_directory }}/haproxy'

    - name: Install HAProxy from source
      command: >
        make install-{{ item }}
      args:
        chdir: '{{ tools_src_directory }}/haproxy'
      become: yes
      with_items:
        - bin
        - man
        # - doc  # stderr: install: cannot stat ‘doc/haproxy-en.txt’: No such file or directory
  tags: [haproxy, packages]

- block:
    - name: Create HAProxy directories
      file: >
        name={{ item }} mode=755 state=directory
      with_items:
        - /etc/haproxy/
        - /var/lib/haproxy/

    - name: Create HAProxy user
      user: >
        name=haproxy shell=/bin/false system=yes state=present

    - name: Configure HAProxy
      template: >
        src=haproxy.cfg.j2 dest=/etc/haproxy/haproxy.cfg mode=644
      notify: reload haproxy

    - name: Set non-local bind kernel parameter
      sysctl: >
        name=net.ipv4.ip_nonlocal_bind value=1 ignoreerrors=yes state=present

    - name: Install HAProxy service
      template: >
        src={{ item.src }}.j2 dest=/etc/{{ item.src }}/haproxy mode={{ item.mode }}
      notify: restart haproxy
      with_items:
        - {src: default, mode: 644}
        - {src: init.d,  mode: 755}

    - name: Copy default HAProxy error pages
      copy: >
        src=errors/ dest=/etc/haproxy/errors/
  become: yes
  tags: [haproxy, config]

- name: Start HAProxy service
  service: >
    name=haproxy state=started enabled=yes
  become: yes
  tags: [haproxy, services]
