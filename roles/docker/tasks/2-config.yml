---

# Setup memory and swap accounting

- name: Check GNU/Linux Kernel supports memory/swap accounting
  assert:
    that:
      "kernel_config[item] == 'y'"
  with_items:
    - memcg
    - memcg_kmem
    - memcg_swap
  when: docker_install_engine|bool

- name: Enable the memory/swap accounting
  lineinfile: >
    dest=/etc/default/grub regexp='GRUB_CMDLINE_LINUX=' backup=yes state=present
    line='GRUB_CMDLINE_LINUX="cgroup_enable=memory swapaccount=1 noprompt"'
  notify: update grub
  become: yes
  when: docker_install_engine|bool

- name: Check memory/swap accounting is active
  command: >
    cat /proc/cmdline
  changed_when: "'cgroup_enable=memory' not in cmdline_result.stdout"
  notify:
    - restart
    - wait started
  register: cmdline_result
  when: docker_install_engine|bool

# Allow our user to communicate with docker daemon without sudo

- name: Create the docker group
  group: >
    name=docker state=present
  become: yes
  when: docker_install_engine|bool

- name: Add our user to the docker group
  user: >
    name={{ ansible_ssh_user }} groups=docker append=yes state=present
  notify:
    - restart
    - wait started
  become: yes
  when: docker_install_engine|bool

# Restart if necessary
- meta: flush_handlers
