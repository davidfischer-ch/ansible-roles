---

- name: Install Docker Machine
  get_url: >
    url=https://github.com/docker/machine/releases/download/v{{ docker_machine_release }}/docker-machine_linux-amd64
    dest="{{ docker_machine_path }}" mode=755 sha256sum=909cae9be74b39cc529fc015aa7c015e1d8f96322d7d92a64004957054965a81
  when: docker_install_machine|bool
  sudo: yes

- name: Provision Docker Machines
  command: >
    docker-machine create -d {{ item.value.provider }} {{ item.key }} {{ item.extra|default('') }}
  tags: provision
  when: docker_install_machine|bool
  with_dict: docker_machines

- name: Install Docker Compose
  get_url: >
    url=https://github.com/docker/compose/releases/download/{{ docker_compose_release }}/run.sh
    dest="{{ docker_compose_path }}" mode=755 sha256sum=e843627e511a7acb2b26eaa1b2f84d1289acd7e280a222c7f5e701b54b40df0b
  when: docker_install_compose|bool
  sudo: yes

- name: Register Docker apt key
  apt_key: >
    keyserver=hkp://p80.pool.sks-keyservers.net:80 id=58118E89F3A912897C070ADBF76221572C52609D state=present
  sudo: yes
  when: docker_install_engine|bool

- name: Register Docker apt repository
  apt_repository: >
    repo="{{ docker_apt_repository }}" update_cache=yes state=present
  sudo: yes
  when: docker_install_engine|bool

- name: Install Docker Engine with apt
  apt: >
    name={{ item }} state=latest
  sudo: yes
  when: docker_install_engine|bool
  with_items: docker_packages

- name: Install Docker Engine with pip
  pip: >
    name={{ item }} state=latest
  sudo: yes
  with_items: docker_python_packages

# FIXME https://github.com/docker/compose/pull/2513#issuecomment-172494821 issue with non tty
# - name: Check Docker Compose version
#   shell:
#     docker-compose version --short
#   register: docker_compose_version_result
#   failed_when: docker_compose_version_result.stdout != docker_compose_release
#   sudo: yes  # FIXME calling docker as simple user is not yet working
