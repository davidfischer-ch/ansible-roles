---

- block:
    - block:
        - name: Register New Relic apt repository
          copy: >
            src=newrelic.list dest=/etc/apt/sources.list.d/newrelic.list mode=644
          register: newrelic_ppa_result

        - name: Trust New Relic GPG key
          shell: >
            wget -O- https://download.newrelic.com/548C16BF.gpg | apt-key add -

        - name: Update the Debian packages cache
          apt: >
            update_cache=yes
          when: newrelic_ppa_result|changed

        - name: Install New Relic System Monitor
          apt: >
            name=newrelic-sysmond state=latest
      when: newrelic_license_key|length > 0

    - name: Remove New Relic System Monitor
      apt: >
        name=newrelic-sysmond state=absent
      when: newrelic_license_key|length == 0
  become: yes
