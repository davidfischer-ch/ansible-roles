---

- block:
    - name: Configure NFS Kernel Server
      template: >
        src=nfs-kernel-server.j2 dest=/etc/default/nfs-kernel-server mode=644
      notify: reload nfs-kernel-server

    - name: Create shared directories
      file: >
        path={{ item.value.path }} owner={{ item.value.user|default(user) }} group={{ item.value.group|default(group) }}
        mode={{ item.value.mode|default(755) }} state=directory
      with_dict: '{{ nfs_exports }}'

    - name: Setup shared directories
      lineinfile: >
        dest=/etc/exports regexp="ansible-roles-key-{{ item.key }}" state={{ item.value.state|default('present') }}
        line="{{ item.value.path }} {{ item.value.rules|join(' ') }}  # ansible-roles-key-{{ item.key }}"
      notify: reload nfs-kernel-server
      with_dict: '{{ nfs_exports }}'
  become: yes
  tags: [nfs, shares]

# FIXME configure exports?
