---

- name: Generate vagrant file
  template: >
    src=Vagrantfile.j2 dest=/tmp/Vagrantfile mode=644

- name: Check machines are up-to-date
  command: >
    vagrant box outdated
  args:
    chdir: /tmp
  changed_when: "'to update' in vagrant_outdated_result.stdout"
  register: vagrant_outdated_result

- name: Update machines
  command: >
    vagrant box update
  args:
    chdir: /tmp
  when: vagrant_outdated_result|changed

- name: Update machines IDs
  script: >
    update-machine-id /tmp {{ item.key }} {{ item.value.provider }}
  changed_when: >
    (vagrant_ids_result.stdout|from_json).new and
    (vagrant_ids_result.stdout|from_json).new != (vagrant_ids_result.stdout|from_json).old
  register: vagrant_ids_result
  with_dict: '{{ vagrant_machines }}'

- name: Provision machines
  command: >
    vagrant up --provider {{ item.value.provider }} {{ item.key }}
  args:
    chdir: /tmp
  changed_when: "'already running' not in vagrant_up_result.stdout"
  register: vagrant_up_result
  with_dict: '{{ vagrant_machines }}'
