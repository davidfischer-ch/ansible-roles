---

- block:
    - name: Configure GitLab URL
      lineinfile: >
        dest=/etc/gitlab/gitlab.rb regexp='^external_url \S+'
        line="external_url 'http{% if gitlab_ssl|bool %}s{% endif %}://{{ domain }}{{ gitlab_web_path }}'"
      notify: restart gitlab
      register: gitlab_url_result

    - name: Check GitLab data directory
      file: >
        name={{ gitlab_data_directory }}{{ item }} state=directory owner=git group=root mode=700
      with_items:
        - ''
        - '/repositories'

    - name: Configure GitLab data directory
      lineinfile: >
        dest=/etc/gitlab/gitlab.rb regexp='^git_data_dir \S+'
        line="git_data_dir '{{ gitlab_data_directory }}'"
      notify: restart gitlab
      register: gitlab_data_result

    - name: Stop GitLab services to free up some memory
      command: >
        gitlab-ctl stop {{ item }}
      when: gitlab_url_result|changed or gitlab_data_result|changed
      with_items:
        - unicorn
        - sidekiq

    - name: Generate GitLab configuration
      command: >
        gitlab-ctl reconfigure
      changed_when: "'  - ' in gitlab_reconfigure_result.stderr"
      register: gitlab_reconfigure_result
  become: yes
